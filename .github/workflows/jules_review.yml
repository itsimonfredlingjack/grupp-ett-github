name: Jules Review

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: jules-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  jules-review:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Start timer
        id: start
        run: echo "epoch=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Validate Jules secret
        id: secret_check
        env:
          JULES_API_KEY: ${{ secrets.JULES_API_KEY }}
        run: |
          if [ -z "$JULES_API_KEY" ]; then
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "JULES_API_KEY is missing; Jules review will be skipped."
          else
            echo "available=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout repository
        if: ${{ steps.secret_check.outputs.available == 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        if: ${{ steps.secret_check.outputs.available == 'true' }}
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build compact Jules payload
        if: ${{ steps.secret_check.outputs.available == 'true' }}
        id: payload
        run: |
          mkdir -p artifacts
          python scripts/jules_payload.py \
            --profile QUICK_REVIEW \
            --repo "$GITHUB_REPOSITORY" \
            --sha "$GITHUB_SHA" \
            --pr-number "${{ github.event.pull_request.number }}" \
            --base-sha "${{ github.event.pull_request.base.sha }}" \
            --head-sha "$GITHUB_SHA" \
            --log-url "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" \
            --output-file artifacts/jules_context.json \
            --github-output "$GITHUB_OUTPUT"

      - name: Invoke Jules review
        if: ${{ steps.secret_check.outputs.available == 'true' }}
        id: jules
        uses: google-labs-code/jules-action@bff7875eaa123cac6742b7cfc51005b95ba4d566 # v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            You are the automated PR reviewer for this repository.
            Keep feedback concise and actionable.
            Prioritize correctness, security, reliability, and test coverage.
            Return at most 8 findings sorted by severity.
            JULES_CONTEXT: ${{ steps.payload.outputs.jules_context }}
          include_last_commit: false
          include_commit_log: false

      - name: Write metrics artifact
        if: always()
        id: metrics
        env:
          START_EPOCH: ${{ steps.start.outputs.epoch }}
          JULES_RESULT: ${{ steps.jules.outcome || 'skipped' }}
          SESSION_ID: ${{ steps.jules.outputs.session_id || '' }}
          FILES_CHANGED_COUNT: ${{ steps.payload.outputs.files_changed_count || '0' }}
          DIFF_BYTES_SENT: ${{ steps.payload.outputs.diff_bytes_sent || '0' }}
          LOG_LINES_SENT: ${{ steps.payload.outputs.log_lines_sent || '0' }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          mkdir -p artifacts
          python - <<'PY'
          import json
          import os
          import time
          from pathlib import Path

          start_epoch = int(os.environ.get("START_EPOCH") or "0")
          duration_sec = max(0, int(time.time()) - start_epoch) if start_epoch else 0

          metrics = {
              "workflow_name": "jules_review.yml",
              "run_id": os.environ.get("GITHUB_RUN_ID"),
              "sha": os.environ.get("GITHUB_SHA"),
              "pr_number": os.environ.get("PR_NUMBER", ""),
              "duration_sec": duration_sec,
              "retries_count": max(0, int(os.environ.get("GITHUB_RUN_ATTEMPT", "1")) - 1),
              "files_changed_count": int(os.environ.get("FILES_CHANGED_COUNT", "0")),
              "diff_bytes_sent": int(os.environ.get("DIFF_BYTES_SENT", "0")),
              "log_lines_sent": int(os.environ.get("LOG_LINES_SENT", "0")),
              "jules_session_id": os.environ.get("SESSION_ID", ""),
              "jules_result": os.environ.get("JULES_RESULT", "skipped"),
              "fix_outcome": "no_change",
          }

          Path("artifacts/jules_metrics.json").write_text(
              json.dumps(metrics, indent=2),
              encoding="utf-8",
          )
          PY

      - name: Upload metrics artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jules-review-metrics-${{ github.run_id }}
          path: |
            artifacts/jules_metrics.json
            artifacts/jules_context.json

      - name: Step summary
        if: always()
        run: |
          echo "## Jules Review Summary" >> "$GITHUB_STEP_SUMMARY"
          echo "- Result: \\`${{ steps.jules.outcome || 'skipped' }}\\`" >> "$GITHUB_STEP_SUMMARY"
          echo "- Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> "$GITHUB_STEP_SUMMARY"
          echo "- Metrics artifact: \\`jules-review-metrics-${{ github.run_id }}\\`" >> "$GITHUB_STEP_SUMMARY"
