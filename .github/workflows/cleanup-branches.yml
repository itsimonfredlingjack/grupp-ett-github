name: Cleanup old branches and PRs

on:
  push:
    branches:
      - 'claude/cleanup-old-branches-*'

permissions:
  contents: write
  pull-requests: write

jobs:
  close-prs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Close all open PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Closing all open pull requests..."
          # List all open PRs and close them
          gh pr list --state open --limit 200 --json number --jq '.[].number' | while read pr_number; do
            echo "Closing PR #${pr_number}..."
            gh pr close "$pr_number" --comment "Closing as part of branch cleanup." || echo "Failed to close PR #${pr_number}"
          done
          echo "Done closing PRs."

  delete-branches:
    runs-on: ubuntu-latest
    needs: close-prs
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Delete old branches
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Deleting old branches..."

          # Branches to keep (never delete these)
          KEEP_BRANCHES="main claude/cleanup-old-branches-aZwu6"

          # Fetch all remote branches
          git fetch --prune origin

          # Get all remote branches
          git branch -r | sed 's|origin/||' | while read branch; do
            # Skip HEAD pointer
            if echo "$branch" | grep -q "HEAD ->"; then
              continue
            fi

            # Trim whitespace
            branch=$(echo "$branch" | xargs)

            # Check if branch should be kept
            should_keep=false
            for keep in $KEEP_BRANCHES; do
              if [ "$branch" = "$keep" ]; then
                should_keep=true
                break
              fi
            done

            if [ "$should_keep" = "true" ]; then
              echo "KEEPING: $branch"
              continue
            fi

            echo "DELETING: $branch"
            git push origin --delete "$branch" 2>&1 || echo "  Failed to delete $branch"
          done

          echo "Done deleting branches."
