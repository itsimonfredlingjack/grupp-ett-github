---
name: finish-task
description: Complete a task - verify all criteria, commit, push, create PR, and update Jira
args: none (uses current task from CURRENT_TASK.md)
---

# Finish Task Skill

> **‚ö†Ô∏è DO NOT invoke this skill manually via `/finish-task`.**
> It is executed automatically as part of the Ralph Loop triggered by `/start-task`.
> This file exists as a reference document for the delivery steps (1-11).

This skill handles the completion workflow for a Ralph Loop task.

## Prerequisites

- Active task in `CURRENT_TASK.md`
- All tests must pass
- All linting must pass
- Changes must be committed

## Workflow

### Step 1: Read Current Task

```
Read CURRENT_TASK.md
Extract: JIRA_ID, branch_name
```

### Step 2: Verify Exit Criteria

Run verification checks:

```bash
# MASTE aktivera venv forst ‚Äî annars ImportError!
source venv/bin/activate && pytest -xvs --cov=src --cov=app.py --cov-report=term-missing --cov-fail-under=80

# Check linting (med venv)
source venv/bin/activate && ruff check .

# Check formatting (med venv)
source venv/bin/activate && ruff format --check .
```

If any check fails, DO NOT proceed. Fix the issues first.

### Step 3: Verify Acceptance Criteria

Review each acceptance criterion in CURRENT_TASK.md.
All checkboxes must be checked.

### Step 3b: Scope Verification (KRITISKT)

**Denna check forhindrar att du loser FEL uppgift.**

Innan du gar vidare, verifiera att dina andringar matchar ticketens scope:

```bash
# Lista alla andrade filer i denna branch
changed_files=$(git diff --name-only main...HEAD)
echo "=== ANDRADE FILER ==="
echo "${changed_files}"
```

**Kontrollera manuellt:**

1. **UI-tickets** ("andra UI", "tema", "design", "frontend"):
   - MASTE inkludera Flask-templates (se filkarta i CLAUDE.md)
   - `src/sejfa/newsflash/presentation/templates/` och/eller
   - `src/expense_tracker/templates/`
   - Om BARA `static/monitor.html` andrades ‚Üí **FEL FILER, STOPPA**

2. **Backend-tickets** ("API", "endpoint", "logik"):
   - MASTE inkludera filer i `src/` (Python-kod)
   - Om bara templates/HTML andrades ‚Üí ifr√•gas√§tt

3. **Generellt:**
   - Jamfor andrade filer mot ticketens acceptanskriterier
   - Om acceptanskriterierna namner produktion/Azure ‚Üí verifiera att
     Flask-serverade filer andrades (se filkarta i CLAUDE.md)

**Om scope inte matchar ‚Üí GA TILLBAKA och andra ratt filer.**

### Step 4: Final Commit

If there are uncommitted changes:

**‚ö†Ô∏è NEVER use `git add -A` or `git add .` ‚Äî they stage untracked junk files (.fuse_hidden*, SEJFA_Changelog.docx, etc.)**

```bash
git add -u   # Only tracked files ‚Äî NO untracked junk
git commit -m "{JIRA_ID}: Final implementation - all tests pass

Co-Authored-By: Claude Code <noreply@anthropic.com>"
```

### Step 5: Push to Remote

```bash
git push -u origin {branch_name}
```

### Step 6: Create Pull Request

Use gh CLI to create PR:

```bash
pr_url=$(gh pr create \
  --title "[{JIRA_ID}] {summary}" \
  --body "## Summary

Implements {JIRA_ID}

## Changes

{list of commits}

## Testing

- [x] Unit tests pass
- [x] Integration tests pass
- [x] Linting passes

## Jira

[{JIRA_ID}](https://your-domain.atlassian.net/browse/{JIRA_ID})

---
ü§ñ *Generated by Claude Code Agent*")
echo "Created PR: ${pr_url}"
```

### Step 7: Merge PR (MANDATORY ‚Äî code MUST reach main)

**FORBJUDET:**
- `gh pr checks --watch` (blockerar oandligt)
- `sleep 30` i manuella loopar (brannen context)
- Separata `gh pr merge` kommandon (kora blocket nedan som ETT kommando)

**Kopiera och kor detta EXAKT som ett Bash-kommando (byt ut `${pr_url}`):**

```bash
PR_URL="${pr_url}" && \
echo "=== MERGE ATTEMPT ===" && \
if gh pr merge --squash --auto "${PR_URL}" 2>/dev/null; then
  echo "‚úÖ Auto-merge enabled"
else
  echo "‚ö†Ô∏è Auto-merge unavailable, trying --admin with retries..."
  MERGED=false
  for i in 1 2 3 4; do
    echo "Attempt ${i}/4: waiting 15s for CI..."
    sleep 15
    if gh pr merge --squash --admin "${PR_URL}" 2>/dev/null; then
      echo "‚úÖ PR merged with --admin (attempt ${i})"
      MERGED=true
      break
    fi
  done
  if [ "${MERGED}" = false ]; then
    echo "‚ö†Ô∏è --admin failed, trying direct --squash..."
    if gh pr merge --squash "${PR_URL}" 2>/dev/null; then
      echo "‚úÖ PR merged directly"
      MERGED=true
    else
      echo "‚ùå ALL MERGE ATTEMPTS FAILED ‚Äî DO NOT SAY DONE"
    fi
  fi
fi && \
echo "=== VERIFY ===" && \
gh pr view "${PR_URL}" --json state,mergedAt -q '{state: .state, mergedAt: .mergedAt}'
```

**Regler:**
- Max vantetid: 4 retries √ó 15s = 60s (INTE mer)
- Om alla misslyckas ‚Üí **DO NOT output `<promise>DONE</promise>`**
- Auto-merge = GitHub merger nar checks passar, du FAR fortsatta till Step 8
- Direkt merge = PR ar mergad, fortsatt till Step 8
- Verifiera ALLTID med `gh pr view --json state` efterat

### Step 8: Update Jira

**IMPORTANT: Use direct Jira API, NOT MCP tools.**

Transition to "In Review":

```bash
source venv/bin/activate && python3 -c "
from dotenv import load_dotenv
load_dotenv()
from src.sejfa.integrations.jira_client import get_jira_client
client = get_jira_client()
try:
    client.transition_issue('{JIRA_ID}', 'In Review')
    print('‚úÖ Transitioned to In Review')
except Exception as e:
    print(f'‚ö†Ô∏è Could not transition: {e}')
"
```

Add completion comment:

```bash
source venv/bin/activate && python3 -c "
from dotenv import load_dotenv
load_dotenv()
from src.sejfa.integrations.jira_client import get_jira_client
client = get_jira_client()
comment = '''ü§ñ Implementation complete!

**Branch:** {branch_name}
**PR:** {pr_url}

All tests pass. Ready for review.'''
try:
    client.add_comment('{JIRA_ID}', comment)
    print('‚úÖ Added comment to Jira')
except Exception as e:
    print(f'‚ö†Ô∏è Could not add comment: {e}')
"
```

### Step 9: Update CURRENT_TASK.md

Mark task as complete:

```markdown
## Active Task

**Jira ID:** {JIRA_ID}
**Status:** ‚úÖ Complete - In Review
**Branch:** {branch_name}
**PR:** {pr_url}
**Completed:** {timestamp}
```

### Note: Automatic Post-Deploy Verification

After merge to main, `deploy.yml` triggers automatically, followed by `post_deploy_verify.yml` which:
1. Verifies the new Azure Container Apps revision is live
2. Runs health check (5 retries √ó 10s interval)
3. On success ‚Üí comments Jira ticket with "‚úÖ Deployed & Verified"
4. On failure ‚Üí rolls back to previous revision + comments Jira "‚ùå Rolled back"

**The agent does NOT need to verify deployment manually.** The pipeline handles this end-to-end.

### Step 10: Output Completion Promise

Only after ALL steps are verified:

```
<promise>DONE</promise>
```

### Step 11: Deactivate Ralph Loop

Remove the loop flag file to allow normal exit.

**Important:** Never remove `.claude/.ralph_loop_active` before `<promise>DONE</promise>` is output ‚Äî the stop-hook fails open when the loop flag is missing, which disables enforcement early.

```bash
rm -f .claude/.ralph_loop_active
```

This signals to the stop-hook that we're no longer in an active task loop.

## Error Handling

- **Tests fail:** Do not proceed, fix tests first
- **Lint fails:** Do not proceed, fix linting issues
- **Push fails:** Check for conflicts, resolve and retry
- **PR creation fails:** Check gh auth status
- **Auto-merge fails:** Confirm branch protection allows auto-merge and required checks are configured
- **Jira update fails:** Log warning but continue (non-blocking)

## Important

This skill should ONLY be invoked when:
1. All acceptance criteria are met
2. All tests pass
3. All linting passes
4. The agent is confident the implementation is complete

The `<promise>DONE</promise>` output triggers the stop-hook to allow exit.
