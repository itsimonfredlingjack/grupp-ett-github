---
name: finish-task
description: Complete a task - verify all criteria, commit, push, create PR, and update Jira
args: none (uses current task from CURRENT_TASK.md)
---

# Finish Task Skill

> **‚ö†Ô∏è DO NOT invoke this skill manually via `/finish-task`.**
> It is executed automatically as part of the Ralph Loop triggered by `/start-task`.
> This file exists as a reference document for the delivery steps (1-11).

This skill handles the completion workflow for a Ralph Loop task.

## Prerequisites

- Active task in `CURRENT_TASK.md`
- All tests must pass
- All linting must pass
- Changes must be committed

## Workflow

### Step 1: Read Current Task

```
Read CURRENT_TASK.md
Extract: JIRA_ID, branch_name
```

### Step 2: Verify Exit Criteria

Run verification checks:

```bash
# Check tests pass
pytest -xvs --cov=src --cov=app.py --cov-report=term-missing --cov-fail-under=80

# Check linting
ruff check .

# Check formatting
ruff format --check .
```

If any check fails, DO NOT proceed. Fix the issues first.

### Step 3: Verify Acceptance Criteria

Review each acceptance criterion in CURRENT_TASK.md.
All checkboxes must be checked.

### Step 3b: Scope Verification (KRITISKT)

**Denna check forhindrar att du loser FEL uppgift.**

Innan du gar vidare, verifiera att dina andringar matchar ticketens scope:

```bash
# Lista alla andrade filer i denna branch
changed_files=$(git diff --name-only main...HEAD)
echo "=== ANDRADE FILER ==="
echo "${changed_files}"
```

**Kontrollera manuellt:**

1. **UI-tickets** ("andra UI", "tema", "design", "frontend"):
   - MASTE inkludera Flask-templates (se filkarta i CLAUDE.md)
   - `src/sejfa/newsflash/presentation/templates/` och/eller
   - `src/expense_tracker/templates/`
   - Om BARA `static/monitor.html` andrades ‚Üí **FEL FILER, STOPPA**

2. **Backend-tickets** ("API", "endpoint", "logik"):
   - MASTE inkludera filer i `src/` (Python-kod)
   - Om bara templates/HTML andrades ‚Üí ifr√•gas√§tt

3. **Generellt:**
   - Jamfor andrade filer mot ticketens acceptanskriterier
   - Om acceptanskriterierna namner produktion/Azure ‚Üí verifiera att
     Flask-serverade filer andrades (se filkarta i CLAUDE.md)

**Om scope inte matchar ‚Üí GA TILLBAKA och andra ratt filer.**

### Step 4: Final Commit

If there are uncommitted changes:

**‚ö†Ô∏è NEVER use `git add -A` or `git add .` ‚Äî they stage untracked junk files (.fuse_hidden*, SEJFA_Changelog.docx, etc.)**

```bash
git add -u   # Only tracked files ‚Äî NO untracked junk
git commit -m "{JIRA_ID}: Final implementation - all tests pass

Co-Authored-By: Claude Code <noreply@anthropic.com>"
```

### Step 5: Push to Remote

```bash
git push -u origin {branch_name}
```

### Step 6: Create Pull Request

Use gh CLI to create PR:

```bash
pr_url=$(gh pr create \
  --title "[{JIRA_ID}] {summary}" \
  --body "## Summary

Implements {JIRA_ID}

## Changes

{list of commits}

## Testing

- [x] Unit tests pass
- [x] Integration tests pass
- [x] Linting passes

## Jira

[{JIRA_ID}](https://your-domain.atlassian.net/browse/{JIRA_ID})

---
ü§ñ *Generated by Claude Code Agent*")
echo "Created PR: ${pr_url}"
```

### Step 7: Merge PR (MANDATORY ‚Äî code MUST reach main)

**DO NOT use `gh pr checks --watch`** ‚Äî it blocks indefinitely waiting
for slow checks like `jules-review` (5-10+ min), burning context tokens.

**Strategy: Try auto-merge first, fall back to --admin merge.**

```bash
# Step 7a: Try auto-merge (non-blocking, GitHub merges when checks pass)
if gh pr merge --squash --auto "${pr_url}" 2>/dev/null; then
  echo "‚úÖ Auto-merge enabled ‚Äî GitHub will merge when checks pass"
else
  echo "‚ö†Ô∏è Auto-merge not available ‚Äî using direct merge"
  # Step 7b: Wait briefly for critical checks, then merge with --admin
  sleep 10  # Give fast checks (lint, security) time to start
  if gh pr merge --squash --admin "${pr_url}" 2>/dev/null; then
    echo "‚úÖ PR merged with --admin flag"
  else
    # Step 7c: Last resort ‚Äî direct squash merge
    gh pr merge --squash "${pr_url}" \
      && echo "‚úÖ PR merged directly" \
      || echo "‚ùå MERGE FAILED ‚Äî PR is NOT merged. DO NOT say DONE."
  fi
fi
```

**‚ö†Ô∏è CRITICAL: The task is NOT complete unless the PR is merged or auto-merge is confirmed enabled.**
- If ALL merge attempts fail ‚Üí **DO NOT output `<promise>DONE</promise>`**
- If auto-merge succeeded ‚Üí PR will merge when checks pass, you MAY proceed
- If direct merge succeeded ‚Üí PR is merged, proceed to Step 8

**Verify merge status:**
```bash
pr_state=$(gh pr view "${pr_url}" --json state -q '.state')
echo "PR state: ${pr_state}"
# Must be MERGED or have auto-merge enabled
```

**NEVER run `gh pr checks --watch` without a timeout.** If you must
poll, use: `timeout 120 gh pr checks "${pr_url}" --watch || true`

### Step 8: Update Jira

**IMPORTANT: Use direct Jira API, NOT MCP tools.**

Transition to "In Review":

```bash
source venv/bin/activate && python3 -c "
from dotenv import load_dotenv
load_dotenv()
from src.sejfa.integrations.jira_client import get_jira_client
client = get_jira_client()
try:
    client.transition_issue('{JIRA_ID}', 'In Review')
    print('‚úÖ Transitioned to In Review')
except Exception as e:
    print(f'‚ö†Ô∏è Could not transition: {e}')
"
```

Add completion comment:

```bash
source venv/bin/activate && python3 -c "
from dotenv import load_dotenv
load_dotenv()
from src.sejfa.integrations.jira_client import get_jira_client
client = get_jira_client()
comment = '''ü§ñ Implementation complete!

**Branch:** {branch_name}
**PR:** {pr_url}

All tests pass. Ready for review.'''
try:
    client.add_comment('{JIRA_ID}', comment)
    print('‚úÖ Added comment to Jira')
except Exception as e:
    print(f'‚ö†Ô∏è Could not add comment: {e}')
"
```

### Step 9: Update CURRENT_TASK.md

Mark task as complete:

```markdown
## Active Task

**Jira ID:** {JIRA_ID}
**Status:** ‚úÖ Complete - In Review
**Branch:** {branch_name}
**PR:** {pr_url}
**Completed:** {timestamp}
```

### Note: Automatic Post-Deploy Verification

After merge to main, `deploy.yml` triggers automatically, followed by `post_deploy_verify.yml` which:
1. Verifies the new Azure Container Apps revision is live
2. Runs health check (5 retries √ó 10s interval)
3. On success ‚Üí comments Jira ticket with "‚úÖ Deployed & Verified"
4. On failure ‚Üí rolls back to previous revision + comments Jira "‚ùå Rolled back"

**The agent does NOT need to verify deployment manually.** The pipeline handles this end-to-end.

### Step 10: Output Completion Promise

Only after ALL steps are verified:

```
<promise>DONE</promise>
```

### Step 11: Deactivate Ralph Loop

Remove the loop flag file to allow normal exit.

**Important:** Never remove `.claude/.ralph_loop_active` before `<promise>DONE</promise>` is output ‚Äî the stop-hook fails open when the loop flag is missing, which disables enforcement early.

```bash
rm -f .claude/.ralph_loop_active
```

This signals to the stop-hook that we're no longer in an active task loop.

## Error Handling

- **Tests fail:** Do not proceed, fix tests first
- **Lint fails:** Do not proceed, fix linting issues
- **Push fails:** Check for conflicts, resolve and retry
- **PR creation fails:** Check gh auth status
- **Auto-merge fails:** Confirm branch protection allows auto-merge and required checks are configured
- **Jira update fails:** Log warning but continue (non-blocking)

## Important

This skill should ONLY be invoked when:
1. All acceptance criteria are met
2. All tests pass
3. All linting passes
4. The agent is confident the implementation is complete

The `<promise>DONE</promise>` output triggers the stop-hook to allow exit.
