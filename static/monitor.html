<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Visual representation of the Ralph Loop development workflow">
  <title>Ralph Loop Monitor - SEJFA</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Background colors */
      --bg-deep: #050810;
      --bg-primary: #0a0f1a;
      --bg-secondary: #111827;
      --bg-elevated: #1a2236;
      --bg-card: rgba(255, 255, 255, 0.02);

      /* Border colors */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-glow: rgba(100, 200, 255, 0.15);

      /* Text colors */
      --text-primary: #f0f4f8;
      --text-secondary: #94a3b8;
      --text-label: #64748b;
      --text-muted: #475569;

      /* Node colors - 5 workflow nodes */
      --color-jira: #8b5cf6;     /* Purple - Jira */
      --color-claude: #06b6d4;   /* Cyan - Claude */
      --color-github: #3b82f6;   /* Blue - GitHub */
      --color-jules: #ec4899;    /* Pink - Jules */
      --color-actions: #10b981;  /* Green - Actions/CI */

      /* Status colors */
      --status-done: #10b981;
      --status-active: #f59e0b;
      --status-pending: #334155;

      /* Typography */
      --font-sans: 'Outfit', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
    }

    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html {
      font-size: 16px;
      -webkit-font-smoothing: antialiased;
    }

    body {
      font-family: var(--font-sans);
      background: radial-gradient(ellipse at 50% 0%, #0f172a 0%, var(--bg-deep) 70%);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* ========== HEADER ========== */
    .header {
      background: linear-gradient(180deg, rgba(10, 15, 26, 0.95) 0%, rgba(10, 15, 26, 0.8) 100%);
      border-bottom: 1px solid var(--border-subtle);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      backdrop-filter: blur(20px);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      width: 42px;
      height: 42px;
      background: conic-gradient(from 0deg, var(--color-jira), var(--color-claude), var(--color-github), var(--color-jules), var(--color-actions), var(--color-jira));
      border-radius: 12px;
      position: relative;
      animation: logo-spin 20s linear infinite;
    }

    @keyframes logo-spin {
      to { filter: hue-rotate(360deg); }
    }

    .logo::after {
      content: '';
      position: absolute;
      inset: 3px;
      background: var(--bg-primary);
      border-radius: 9px;
    }

    .header h1 {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.02em;
      background: linear-gradient(135deg, var(--text-primary) 0%, var(--text-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-subtle);
      padding: 10px 20px;
      border-radius: 100px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      background: var(--status-done);
      border-radius: 50%;
      box-shadow: 0 0 16px var(--status-done);
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.idle {
      background: var(--status-pending);
      box-shadow: none;
      animation: none;
    }

    .status-dot.paused {
      background: var(--status-active);
      box-shadow: 0 0 16px var(--status-active);
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(0.85); opacity: 0.6; }
    }

    /* ========== MAIN LAYOUT ========== */
    .main {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 360px;
      gap: 48px;
      max-width: 1440px;
      width: 100%;
      margin: 0 auto;
      padding: 32px 56px;
      align-items: start;
    }

    @media (max-width: 1200px) {
      .main {
        grid-template-columns: 1fr;
        gap: 40px;
        padding: 32px 24px;
      }
    }

    /* ========== ORBITAL CONTAINER ========== */
    .orbital-container {
      display: flex;
      align-items: flex-start;
      justify-content: center;
      position: relative;
      cursor: pointer;
      padding-top: 0;
    }

    .orbital-svg {
      width: 500px;
      height: 500px;
    }

    /* Progress ring */
    .progress-track-ring {
      fill: none;
      stroke: rgba(100, 116, 139, 0.12);
      stroke-width: 4;
    }

    .progress-ring {
      fill: none;
      stroke: url(#progressGradient);
      stroke-width: 4;
      stroke-linecap: round;
      transform-origin: center;
      transform: rotate(-90deg);
      transition: stroke-dashoffset 1.5s ease-in-out;
    }

    /* Node styling */
    .node {
      cursor: pointer;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .node:hover {
      transform: scale(1.08);
    }

    .node-bg {
      fill: var(--bg-secondary);
      stroke: var(--border-subtle);
      stroke-width: 2;
      transition: all 0.8s ease-in-out;
    }

    .node-icon {
      color: var(--text-muted);
      transition: all 0.4s;
    }

    .node-label {
      font-family: var(--font-mono);
      font-size: 11px;
      font-weight: 500;
      fill: var(--text-label);
      letter-spacing: 0.02em;
      transition: all 0.4s;
    }

    /* Active node */
    .node.active .node-bg {
      fill: var(--node-color);
      stroke: var(--node-color);
      filter: drop-shadow(0 0 24px var(--node-glow));
    }

    .node.active .node-icon {
      color: var(--bg-deep);
    }

    .node.active .node-label {
      fill: var(--text-primary);
      font-weight: 600;
    }

    /* Done node */
    .node.done .node-bg {
      fill: var(--node-color);
      stroke: var(--node-color);
      opacity: 0.65;
    }

    .node.done .node-icon {
      color: var(--bg-deep);
      opacity: 0.85;
    }

    /* Orbiting marker */
    .orbit-marker {
      filter: drop-shadow(0 0 16px currentColor);
      transition:
        fill 0.6s ease-in-out,
        cx 1.8s ease-in-out,
        cy 1.8s ease-in-out;
    }

    .orbit-marker-glow {
      fill: none;
      stroke-width: 2;
      opacity: 0.5;
      animation: marker-ring-pulse 2s ease-out infinite;
      transition:
        cx 1.8s ease-in-out,
        cy 1.8s ease-in-out,
        stroke 0.6s ease-in-out;
    }

    @keyframes marker-ring-pulse {
      0% { r: 8; opacity: 0.6; }
      100% { r: 24; opacity: 0; }
    }

    /* Center trigger node */
    .trigger-node {
      cursor: pointer;
      transform-origin: 250px 250px;
      animation: trigger-scale 2s ease-in-out infinite;
    }

    @keyframes trigger-scale {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .trigger-bg {
      fill: url(#triggerGradient);
      stroke: rgba(59, 130, 246, 0.5);
      stroke-width: 2;
      filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.6));
      animation: trigger-glow 2s ease-in-out infinite;
    }

    @keyframes trigger-glow {
      0%, 100% {
        filter: drop-shadow(0 0 20px rgba(59, 130, 246, 0.4));
        stroke: rgba(59, 130, 246, 0.4);
      }
      50% {
        filter: drop-shadow(0 0 30px rgba(59, 130, 246, 0.8));
        stroke: rgba(6, 182, 212, 0.7);
      }
    }

    .trigger-prompt {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 700;
      fill: #ffffff;
    }

    .trigger-label {
      font-family: var(--font-mono);
      font-size: 10px;
      fill: var(--color-jira);
      letter-spacing: 0.02em;
      font-weight: 500;
    }

    /* Pulse ring */
    .trigger-pulse-ring {
      fill: none;
      stroke: url(#triggerGradient);
      stroke-width: 3;
      opacity: 0;
      pointer-events: none;
    }

    .trigger-pulse-ring.active {
      animation: pulse-expand 1.5s ease-out forwards;
    }

    @keyframes pulse-expand {
      0% { r: 24; opacity: 0.8; stroke-width: 4; }
      100% { r: 120; opacity: 0; stroke-width: 1; }
    }

    .click-hint {
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--text-muted);
      opacity: 0.4;
      transition: opacity 0.3s;
    }

    .orbital-container:hover .click-hint {
      opacity: 0.7;
    }

    /* ========== RALPH INFO PANEL ========== */
    .ralph-panel {
      background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 16px;
    }

    .ralph-panel h3 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-jira);
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .ralph-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .ralph-stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .ralph-stat-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-label);
    }

    .ralph-stat-value {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .ralph-stat-value.highlight {
      color: var(--color-claude);
    }

    /* ========== SIDE PANEL ========== */
    .side-panel {
      display: flex;
      flex-direction: column;
      gap: 16px;
      height: fit-content;
      max-height: calc(100vh - 160px);
    }

    .panel-card {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
      border: 1px solid var(--border-subtle);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.3s;
    }

    .panel-card:hover {
      border-color: var(--border-glow);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .panel-card--events {
      flex: 1;
      min-height: 280px;
      max-height: 400px;
      display: flex;
      flex-direction: column;
    }

    .panel-card--events .event-log {
      flex: 1;
      overflow-y: auto;
      min-height: 0;
    }

    .panel-card--compact {
      flex: 0 0 auto;
      padding: 16px 20px;
    }

    .section-label {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-label);
      margin-bottom: 16px;
    }

    /* Current Task */
    .task-id {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--color-jira);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .task-title {
      font-size: 18px;
      font-weight: 600;
      line-height: 1.4;
      margin-bottom: 16px;
      color: var(--text-primary);
    }

    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .task-status {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .task-timer {
      font-family: var(--font-mono);
      font-variant-numeric: tabular-nums;
      font-weight: 500;
    }

    /* Active Step */
    .active-step {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-bottom: 20px;
    }

    .step-marker {
      width: 48px;
      height: 48px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 600;
      color: var(--bg-deep);
      box-shadow: 0 4px 20px var(--step-shadow);
      transition: all 0.4s;
    }

    .step-info h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .step-info p {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* Progress bar */
    .progress-track {
      height: 6px;
      background: var(--bg-elevated);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-jira), var(--color-actions));
      border-radius: 3px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .progress-fill::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s ease-in-out infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Event Log */
    .event-log {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .event-item {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      transition: all 0.3s;
    }

    .event-item:last-child {
      border-bottom: none;
    }

    .event-marker {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: bold;
      transition: all 0.3s;
    }

    .event-item.done .event-marker {
      background: var(--status-done);
      box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
      color: var(--bg-deep);
    }

    .event-item.done { color: var(--text-secondary); }

    .event-item.active .event-marker {
      background: var(--status-active);
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.6);
      animation: glow-pulse 1.5s ease-in-out infinite;
    }

    .event-item.active {
      color: var(--text-primary);
      font-weight: 500;
    }

    @keyframes glow-pulse {
      0%, 100% { box-shadow: 0 0 12px rgba(245, 158, 11, 0.6); }
      50% { box-shadow: 0 0 20px rgba(245, 158, 11, 0.9); }
    }

    .event-item.pending .event-marker {
      background: var(--status-pending);
    }

    .event-item.pending { color: var(--text-muted); }

    /* Footer */
    .footer {
      background: rgba(10, 15, 26, 0.6);
      border-top: 1px solid var(--border-subtle);
      padding: 20px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-muted);
    }

    .footer a {
      color: var(--text-secondary);
      text-decoration: none;
      transition: color 0.2s;
    }

    .footer a:hover { color: var(--text-primary); }

    /* Responsive */
    @media (max-width: 768px) {
      .header { padding: 16px 20px; }
      .header h1 { font-size: 18px; }
      .orbital-svg { width: 340px; height: 340px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="logo"></div>
      <h1>Ralph Loop Monitor</h1>
    </div>
    <div class="status-indicator">
      <span class="status-dot idle" id="statusDot"></span>
      <span id="statusText">Waiting</span>
    </div>
  </header>

  <main class="main">
    <section class="orbital-container" id="orbitalContainer">
      <svg class="orbital-svg" viewBox="0 0 500 500">
        <defs>
          <!-- Progress gradient -->
          <linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#8b5cf6"/>
            <stop offset="25%" stop-color="#06b6d4"/>
            <stop offset="50%" stop-color="#3b82f6"/>
            <stop offset="75%" stop-color="#ec4899"/>
            <stop offset="100%" stop-color="#10b981"/>
          </linearGradient>

          <!-- Trigger node gradient -->
          <linearGradient id="triggerGradient" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" stop-color="#8b5cf6"/>
            <stop offset="100%" stop-color="#06b6d4"/>
          </linearGradient>
        </defs>

        <!-- Progress ring track -->
        <circle class="progress-track-ring" cx="250" cy="250" r="160"/>

        <!-- Progress ring fill -->
        <circle
          class="progress-ring"
          id="progressRing"
          cx="250"
          cy="250"
          r="160"
          stroke-dasharray="1005"
          stroke-dashoffset="1005"
        />

        <!-- NODE 0: JIRA (top) -->
        <g class="node" data-step="0" style="--node-color: var(--color-jira); --node-glow: rgba(139, 92, 246, 0.5)">
          <circle class="node-bg" cx="250" cy="90" r="32"/>
          <g class="node-icon" transform="translate(250, 90)">
            <rect x="-9" y="-11" width="18" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
            <rect x="-5" y="-15" width="10" height="5" rx="1" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="-5" y1="-1" x2="5" y2="-1" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <line x1="-5" y1="4" x2="3" y2="4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </g>
          <text x="250" y="46" text-anchor="middle" class="node-label">JIRA</text>
        </g>

        <!-- NODE 1: CLAUDE (right-top) -->
        <g class="node" data-step="1" style="--node-color: var(--color-claude); --node-glow: rgba(6, 182, 212, 0.5)">
          <circle class="node-bg" cx="388.56" cy="170" r="32"/>
          <g class="node-icon" transform="translate(388.56, 170)">
            <path d="M -10 -8 L -4 0 L -10 8" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="0" y1="8" x2="9" y2="8" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            <circle cx="6" cy="-2" r="3" fill="currentColor"/>
          </g>
          <text x="432" y="175" text-anchor="start" class="node-label">CLAUDE</text>
        </g>

        <!-- NODE 2: GITHUB (right-bottom) -->
        <g class="node" data-step="2" style="--node-color: var(--color-github); --node-glow: rgba(59, 130, 246, 0.5)">
          <circle class="node-bg" cx="388.56" cy="330" r="32"/>
          <g class="node-icon" transform="translate(388.56, 330)">
            <circle cx="-5" cy="-7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="5" cy="-2" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="-5" cy="7" r="3" fill="none" stroke="currentColor" stroke-width="2"/>
            <line x1="-5" y1="-4" x2="-5" y2="4" stroke="currentColor" stroke-width="2"/>
            <path d="M -5 -2 Q 0 -2 5 1" fill="none" stroke="currentColor" stroke-width="2"/>
          </g>
          <text x="432" y="335" text-anchor="start" class="node-label">GITHUB</text>
        </g>

        <!-- NODE 3: JULES (left-bottom) -->
        <g class="node" data-step="3" style="--node-color: var(--color-jules); --node-glow: rgba(236, 72, 153, 0.5)">
          <circle class="node-bg" cx="111.44" cy="330" r="32"/>
          <g class="node-icon" transform="translate(111.44, 330)">
            <path d="M -12 0 Q 0 -10 12 0 Q 0 10 -12 0" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="0" cy="0" r="4" fill="none" stroke="currentColor" stroke-width="2"/>
            <circle cx="0" cy="0" r="1.5" fill="currentColor"/>
          </g>
          <text x="68" y="335" text-anchor="end" class="node-label">JULES</text>
        </g>

        <!-- NODE 4: ACTIONS/CI (left-top) -->
        <g class="node" data-step="4" style="--node-color: var(--color-actions); --node-glow: rgba(16, 185, 129, 0.5)">
          <circle class="node-bg" cx="111.44" cy="170" r="32"/>
          <g class="node-icon" transform="translate(111.44, 170)">
            <circle cx="0" cy="0" r="7" fill="none" stroke="currentColor" stroke-width="2"/>
            <g stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <line x1="0" y1="-11" x2="0" y2="-7"/>
              <line x1="0" y1="7" x2="0" y2="11"/>
              <line x1="-11" y1="0" x2="-7" y2="0"/>
              <line x1="7" y1="0" x2="11" y2="0"/>
            </g>
            <polygon points="-2,-3 -2,3 3,0" fill="currentColor"/>
          </g>
          <text x="68" y="175" text-anchor="end" class="node-label">ACTIONS</text>
        </g>

        <!-- CENTER TRIGGER NODE -->
        <circle class="trigger-pulse-ring" id="triggerPulseRing" cx="250" cy="250" r="24"/>

        <g class="trigger-node">
          <circle class="trigger-bg" cx="250" cy="250" r="24"/>
          <text x="250" y="255" text-anchor="middle" class="trigger-prompt">&gt;_</text>
          <text x="250" y="285" text-anchor="middle" class="trigger-label">/start-task</text>
        </g>

        <!-- Orbiting marker -->
        <circle class="orbit-marker-glow" id="markerGlow" cx="250" cy="90" r="8" stroke="var(--color-jira)"/>
        <circle class="orbit-marker" id="orbitMarker" cx="250" cy="90" r="6" fill="var(--color-jira)"/>
      </svg>
      <div class="click-hint">Click or Space to pause</div>
    </section>

    <aside class="side-panel">
      <!-- Ralph Loop Info Panel -->
      <div class="ralph-panel">
        <h3>RALPH LOOP</h3>
        <div class="ralph-stats">
          <div class="ralph-stat">
            <span class="ralph-stat-label">Iteration</span>
            <span class="ralph-stat-value" id="ralphIteration">0 / 25</span>
          </div>
          <div class="ralph-stat">
            <span class="ralph-stat-label">Criteria</span>
            <span class="ralph-stat-value highlight" id="ralphCriteria">0 / 0</span>
          </div>
        </div>
      </div>

      <!-- Event Log -->
      <div class="panel-card panel-card--events">
        <div class="section-label">Event Log</div>
        <ul class="event-log" id="eventLog">
          <li class="event-item pending" data-step="0"><span class="event-marker"></span><span>Fetch Jira ticket</span></li>
          <li class="event-item pending" data-step="1"><span class="event-marker"></span><span>Claude writes code</span></li>
          <li class="event-item pending" data-step="2"><span class="event-marker"></span><span>Push to GitHub</span></li>
          <li class="event-item pending" data-step="3"><span class="event-marker"></span><span>Jules code review</span></li>
          <li class="event-item pending" data-step="4"><span class="event-marker"></span><span>Run CI pipeline</span></li>
        </ul>
      </div>

      <!-- Active Step -->
      <div class="panel-card panel-card--compact">
        <div class="section-label">Active Step</div>
        <div class="active-step">
          <div class="step-marker" id="stepMarker" style="background: var(--color-jira); --step-shadow: rgba(139, 92, 246, 0.4)">?</div>
          <div class="step-info">
            <h3 id="stepName">Idle</h3>
            <p id="stepDesc">Run /start-task PROJ-XXX to begin</p>
          </div>
        </div>
        <div class="progress-track">
          <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
      </div>

      <!-- Current Task -->
      <div class="panel-card panel-card--compact">
        <div class="section-label">Current Task</div>
        <div class="task-id" id="taskId">--</div>
        <div class="task-title" id="taskTitle">Waiting for task...</div>
        <div class="task-meta">
          <span class="task-status" id="taskStatus">Pending</span>
          <span class="task-timer" id="taskTimer">0:00</span>
        </div>
      </div>
    </aside>
  </main>

  <footer class="footer">
    <span>SEJFA - Ralph Loop Monitor</span>
    <span>WebSocket: <span id="wsStatus">Connecting...</span></span>
  </footer>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // ════════════════════════════════════════════════════════════════
    // RALPH LOOP MONITOR - Real-time WebSocket Dashboard
    // ════════════════════════════════════════════════════════════════

    const RADIUS = 160;
    const CENTER = 250;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;

    // 5 workflow nodes (pentagon layout)
    const nodePositions = [
      { x: 250, y: 90 },      // 0: JIRA (top)
      { x: 388.56, y: 170 },  // 1: CLAUDE (right-top)
      { x: 388.56, y: 330 },  // 2: GITHUB (right-bottom)
      { x: 111.44, y: 330 },  // 3: JULES (left-bottom)
      { x: 111.44, y: 170 }   // 4: ACTIONS (left-top)
    ];

    const steps = [
      { name: 'Jira Ticket', desc: 'Fetching ticket requirements...', color: '#8b5cf6', shadow: 'rgba(139, 92, 246, 0.4)', progress: 20 },
      { name: 'Claude Code', desc: 'Writing tests and implementation...', color: '#06b6d4', shadow: 'rgba(6, 182, 212, 0.4)', progress: 40 },
      { name: 'GitHub PR', desc: 'Pushing code and creating PR...', color: '#3b82f6', shadow: 'rgba(59, 130, 246, 0.4)', progress: 60 },
      { name: 'Jules Review', desc: 'AI reviewing code changes...', color: '#ec4899', shadow: 'rgba(236, 72, 153, 0.4)', progress: 80 },
      { name: 'CI Pipeline', desc: 'Running tests and validation...', color: '#10b981', shadow: 'rgba(16, 185, 129, 0.4)', progress: 100 }
    ];

    let currentStep = -1;
    let isPaused = false;
    let elapsedSeconds = 0;
    let ws = null;
    let reconnectAttempts = 0;
    let timerInterval = null;

    // DOM elements
    const orbitMarker = document.getElementById('orbitMarker');
    const markerGlow = document.getElementById('markerGlow');
    const progressRing = document.getElementById('progressRing');
    const triggerPulseRing = document.getElementById('triggerPulseRing');
    const nodes = document.querySelectorAll('.node');
    const stepMarker = document.getElementById('stepMarker');
    const stepName = document.getElementById('stepName');
    const stepDesc = document.getElementById('stepDesc');
    const progressFill = document.getElementById('progressFill');
    const eventLog = document.getElementById('eventLog');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const taskTimer = document.getElementById('taskTimer');
    const taskId = document.getElementById('taskId');
    const taskTitle = document.getElementById('taskTitle');
    const taskStatus = document.getElementById('taskStatus');
    const wsStatus = document.getElementById('wsStatus');
    const ralphIteration = document.getElementById('ralphIteration');
    const ralphCriteria = document.getElementById('ralphCriteria');

    // ════════════════════════════════════════════════════════════════
    // Socket.IO Connection
    // ════════════════════════════════════════════════════════════════

    function connectWebSocket() {
      if (typeof window.io !== 'function') {
        console.log('Socket.IO client unavailable - falling back to polling');
        wsStatus.textContent = 'Polling';
        startPolling();
        return;
      }

      console.log('Connecting to Socket.IO endpoint');
      wsStatus.textContent = 'Connecting...';

      try {
        ws = window.io({
          transports: ['websocket', 'polling'],
          reconnection: true,
          reconnectionAttempts: Infinity,
          reconnectionDelay: 1000,
          reconnectionDelayMax: 30000
        });

        ws.on('connect', () => {
          console.log('Socket.IO connected');
          reconnectAttempts = 0;
          wsStatus.textContent = 'Connected';
          statusDot.classList.remove('idle');
          ws.emit('get_state');
        });

        ws.on('disconnect', () => {
          console.log('Socket.IO disconnected');
          wsStatus.textContent = 'Disconnected';
          statusDot.classList.add('idle');
        });

        ws.on('connect_error', (error) => {
          console.error('Socket.IO connection error:', error);
          wsStatus.textContent = 'Error';
          if (!pollingInterval) {
            startPolling();
          }
        });

        ws.on('init', (message) => handleMessage(message));
        ws.on('task_update', (message) => handleMessage(message));
        ws.on('event', (message) => handleMessage(message));
        ws.on('status', (message) => handleMessage(message));
        ws.on('reset', (message) => handleMessage(message));
        ws.on('pong', (message) => handleMessage(message));
      } catch (e) {
        console.error('Socket.IO connection failed:', e);
        wsStatus.textContent = 'Failed';
        startPolling();
      }
    }

    // ════════════════════════════════════════════════════════════════
    // Polling Fallback (for when WebSocket is unavailable)
    // ════════════════════════════════════════════════════════════════

    let pollingInterval = null;

    function startPolling() {
      if (pollingInterval) return;

      wsStatus.textContent = 'Polling';

      pollingInterval = setInterval(async () => {
        try {
          const response = await fetch('/api/monitor/state');
          const data = await response.json();
          handleInit(data);
        } catch (e) {
          console.error('Polling error:', e);
        }
      }, 2000);
    }

    // ════════════════════════════════════════════════════════════════
    // Message Handlers
    // ════════════════════════════════════════════════════════════════

    function handleMessage(message) {
      console.log('Received:', message.type, message);

      switch (message.type) {
        case 'init':
          handleInit(message.data);
          break;
        case 'task_update':
          handleTaskUpdate(message.data);
          break;
        case 'event':
          handleEvent(message.data);
          break;
        case 'status':
          handleStatusChange(message.status);
          break;
        case 'reset':
          handleReset();
          break;
        case 'pong':
          break;
      }
    }

    function handleInit(data) {
      console.log('Initializing with state:', data);

      elapsedSeconds = data.elapsed_seconds || 0;
      updateTimer();

      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (!isPaused && currentStep >= 0) {
          elapsedSeconds++;
          updateTimer();
        }
      }, 1000);

      if (data.task) {
        handleTaskUpdate(data.task);
      } else {
        setIdleState();
      }

      if (data.status === 'paused') {
        isPaused = true;
        statusDot.classList.add('paused');
        statusText.textContent = 'Paused';
      } else if (data.status === 'running') {
        isPaused = false;
        statusDot.classList.remove('paused', 'idle');
        statusText.textContent = 'Running';
      } else {
        setIdleState();
      }

      if (data.events && data.events.length > 0) {
        renderEvents(data.events);
      }

      // Fetch Ralph state from CURRENT_TASK.md
      fetchRalphState();
    }

    function handleTaskUpdate(task) {
      console.log('Task update:', task);

      if (task.task_id) {
        taskId.textContent = task.task_id;
      }
      if (task.title) {
        taskTitle.textContent = task.title;
      }

      if (typeof task.step === 'number' && task.step >= 0 && task.step <= 4) {
        const previousStep = currentStep;
        currentStep = task.step;

        if (previousStep === -1 && currentStep === 0) {
          triggerPulse();
        }

        updateOrbitalView(currentStep, task.step_name, task.step_desc);
      }

      if (task.status) {
        const statusMap = {
          'pending': 'Pending',
          'in_progress': 'In Progress',
          'done': 'Complete',
          'failed': 'Failed'
        };
        taskStatus.textContent = statusMap[task.status] || task.status;
      }

      if (task.iteration !== undefined) {
        const maxIter = task.max_iterations || 25;
        ralphIteration.textContent = `${task.iteration} / ${maxIter}`;
      }

      statusText.textContent = 'Running';
      statusDot.classList.remove('paused', 'idle');
    }

    function handleEvent(event) {
      console.log('Event:', event);
      addEventToLog(event);
    }

    function handleStatusChange(status) {
      isPaused = status === 'paused';
      statusDot.classList.toggle('paused', isPaused);
      statusText.textContent = isPaused ? 'Paused' : 'Running';
    }

    function handleReset() {
      currentStep = -1;
      elapsedSeconds = 0;
      updateTimer();
      setIdleState();
      clearEventLog();
    }

    // ════════════════════════════════════════════════════════════════
    // Ralph State (from CURRENT_TASK.md)
    // ════════════════════════════════════════════════════════════════

    async function fetchRalphState() {
      try {
        const response = await fetch('/api/monitor/ralph-state');
        const data = await response.json();

        if (data.active) {
          ralphCriteria.textContent = `${data.criteria_checked} / ${data.criteria_total}`;

          if (data.iteration) {
            ralphIteration.textContent = `${data.iteration} / 25`;
          }
        }
      } catch (e) {
        console.error('Failed to fetch Ralph state:', e);
      }
    }

    // Refresh Ralph state periodically
    setInterval(fetchRalphState, 5000);

    // ════════════════════════════════════════════════════════════════
    // UI Update Functions
    // ════════════════════════════════════════════════════════════════

    function setIdleState() {
      currentStep = -1;
      statusText.textContent = 'Waiting';
      statusDot.classList.add('idle');

      taskId.textContent = '--';
      taskTitle.textContent = 'Waiting for task...';
      taskStatus.textContent = 'Pending';
      stepMarker.textContent = '?';
      stepMarker.style.background = 'var(--status-pending)';
      stepName.textContent = 'Idle';
      stepDesc.textContent = 'Run /start-task PROJ-XXX to begin';
      progressFill.style.width = '0%';

      progressRing.style.strokeDashoffset = CIRCUMFERENCE;

      nodes.forEach(node => {
        node.classList.remove('active', 'done');
        node.querySelector('.node-bg').setAttribute('r', '32');
      });

      orbitMarker.style.opacity = '0.3';
      markerGlow.style.opacity = '0';

      const items = eventLog.querySelectorAll('.event-item[data-step]');
      items.forEach(item => {
        item.classList.remove('done', 'active');
        item.classList.add('pending');
        item.querySelector('.event-marker').textContent = '';
      });
    }

    function updateOrbitalView(index, customName, customDesc) {
      if (index < 0 || index > 4) return;

      const step = steps[index];
      const pos = nodePositions[index];

      orbitMarker.style.opacity = '1';
      markerGlow.style.opacity = '1';

      orbitMarker.setAttribute('cx', pos.x);
      orbitMarker.setAttribute('cy', pos.y);
      orbitMarker.style.fill = step.color;
      markerGlow.setAttribute('cx', pos.x);
      markerGlow.setAttribute('cy', pos.y);
      markerGlow.style.stroke = step.color;

      const completedFraction = (index + 1) / steps.length;
      const dashOffset = CIRCUMFERENCE * (1 - completedFraction);
      progressRing.style.strokeDashoffset = dashOffset;

      nodes.forEach((node, i) => {
        node.classList.remove('active', 'done');
        const bg = node.querySelector('.node-bg');

        if (i < index) {
          node.classList.add('done');
          bg.setAttribute('r', '32');
        } else if (i === index) {
          node.classList.add('active');
          bg.setAttribute('r', '38');
        } else {
          bg.setAttribute('r', '32');
        }
      });

      stepMarker.style.background = step.color;
      stepMarker.style.setProperty('--step-shadow', step.shadow);
      stepMarker.textContent = index + 1;
      stepName.textContent = customName || step.name;
      stepDesc.textContent = customDesc || step.desc;
      progressFill.style.width = step.progress + '%';

      const items = eventLog.querySelectorAll('.event-item[data-step]');
      items.forEach((item, i) => {
        item.classList.remove('done', 'active', 'pending');
        const marker = item.querySelector('.event-marker');

        if (i < index) {
          item.classList.add('done');
          marker.textContent = '✓';
        } else if (i === index) {
          item.classList.add('active');
          marker.textContent = '';
        } else {
          item.classList.add('pending');
          marker.textContent = '';
        }
      });
    }

    function updateTimer() {
      const mins = Math.floor(elapsedSeconds / 60);
      const secs = elapsedSeconds % 60;
      taskTimer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function triggerPulse() {
      triggerPulseRing.classList.remove('active');
      void triggerPulseRing.offsetWidth;
      triggerPulseRing.classList.add('active');
    }

    // ════════════════════════════════════════════════════════════════
    // Event Log Functions
    // ════════════════════════════════════════════════════════════════

    function addEventToLog(event) {
      const li = document.createElement('li');
      li.className = 'event-item';

      const typeColors = {
        success: 'var(--status-done)',
        error: '#ef4444',
        warning: 'var(--status-active)',
        info: 'var(--color-claude)'
      };
      const color = typeColors[event.event_type] || 'var(--text-secondary)';

      const typeIcons = {
        success: '✓',
        error: '✕',
        warning: '!',
        info: '→'
      };
      const icon = typeIcons[event.event_type] || '•';

      li.innerHTML = `
        <span class="event-marker" style="background: ${color}; box-shadow: 0 0 8px ${color}; color: var(--bg-deep); font-size: 8px;">${icon}</span>
        <span style="flex: 1;">${event.message}</span>
        <span style="font-family: var(--font-mono); font-size: 11px; color: var(--text-muted);">${event.source || ''}</span>
      `;

      const stepItems = eventLog.querySelectorAll('.event-item[data-step]');
      if (stepItems.length > 0) {
        stepItems[stepItems.length - 1].after(li);
      } else {
        eventLog.prepend(li);
      }

      li.style.opacity = '0';
      li.style.transform = 'translateX(-10px)';
      requestAnimationFrame(() => {
        li.style.transition = 'all 0.3s ease';
        li.style.opacity = '1';
        li.style.transform = 'translateX(0)';
      });

      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      if (customEvents.length > 14) {
        customEvents[customEvents.length - 1].remove();
      }
    }

    function renderEvents(events) {
      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      customEvents.forEach(e => e.remove());

      events.slice().reverse().forEach(event => {
        addEventToLog(event);
      });
    }

    function clearEventLog() {
      const customEvents = eventLog.querySelectorAll('.event-item:not([data-step])');
      customEvents.forEach(e => e.remove());
    }

    // ════════════════════════════════════════════════════════════════
    // Pause/Resume
    // ════════════════════════════════════════════════════════════════

    function togglePause() {
      isPaused = !isPaused;
      statusDot.classList.toggle('paused', isPaused);
      statusText.textContent = isPaused ? 'Paused' : (currentStep >= 0 ? 'Running' : 'Waiting');
    }

    document.getElementById('orbitalContainer').addEventListener('click', togglePause);
    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space') {
        e.preventDefault();
        togglePause();
      }
    });

    // ════════════════════════════════════════════════════════════════
    // Heartbeat
    // ════════════════════════════════════════════════════════════════

    setInterval(() => {
      if (ws && ws.connected) {
        ws.emit('ping');
      }
    }, 30000);

    // ════════════════════════════════════════════════════════════════
    // Initialize
    // ════════════════════════════════════════════════════════════════

    setIdleState();

    // Try WebSocket first, fall back to polling
    if (window.location.protocol !== 'file:') {
      connectWebSocket();

      // If Socket.IO doesn't connect within 5s, start polling
      setTimeout(() => {
        if (!ws || !ws.connected) {
          console.log('Socket.IO unavailable - falling back to polling');
          startPolling();
        }
      }, 5000);
    } else {
      // Running from file:// - just show idle state
      wsStatus.textContent = 'N/A (file://)';
    }
  </script>
</body>
</html>
